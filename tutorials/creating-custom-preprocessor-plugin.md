# **Creating a Custom Preprocessor Plugin for BrainScape**

This tutorial guides you through creating and registering a custom preprocessor plugin for BrainScape. It assumes you have read the [**BrainScape API Overview**](https://github.com/yasinzaii/BrainScape/blob/main/tutorials/BrainScape-API-overview.md) tutorial, which describes the internal plugin architecture, plugin loaders, and stage managers.

---

## 1. Overview

Every preprocessor plugin:

* Inherits from the abstract base class `PreprocessorPlugin` located in:

  ```
  src/preprocess/preprocessor/base_plugin.py
  ```
* Must define a unique `plugin_name`.
* Must implement the abstract method `run()`, which handles preprocessing logic.
* Receives dataset-specific settings, a path to the dataset directory, and the mapping (generated by the mapper stage).

Dataset-specific configurations select which plugin runs, enabling flexible pipelines without altering core engine code.

---

## 2. Directory Structure

Your custom plugin must reside here:

```
src/preprocess/preprocessor/
```

Example:

```
src/preprocess/preprocessor/my_custom_preprocessor.py
```

---

## 3. Preprocessor Plugin Template

Below is a template for your custom preprocessor:

```python
from preprocess.preprocessor.base_plugin import PreprocessorPlugin
from pathlib import Path
from typing import Dict, Any
import logging

class MyCustomPreprocessor(PreprocessorPlugin):

    plugin_name = "my_custom_preprocessor"

    @classmethod
    def get_name(cls) -> str:
        return cls.plugin_name

    def __init__(self, dataset_settings: Dict[str, Any], dataset_path: Path, mapping: Dict[str, Any], config: Dict[str, Any]):
        super().__init__(dataset_settings, dataset_path, mapping, config)
        """
        Args:
            dataset_settings (dict): Dataset-specific settings.
            dataset_path (str): Path to the dataset directory.
            mapping (dict): Dataset Mapping - Aquired from Mapper Module. 
            config (dict): Configurations

        """
        self.logger = logging.getLogger(__name__)

        self.download_dir = self.dataset_path / dataset_settings.get("downloadDirName", "Download")
        self.preprocess_dir_name = dataset_settings.get("preprocessDirName", "preprocessed")
        self.preprocess_dir = self.dataset_path / self.preprocess_dir_name

        # Ensure output directory exists
        self.preprocess_dir.mkdir(parents=True, exist_ok=True)

        # Custom plugin-specific settings
        self.plugin_config = dataset_settings["preprocess"].get("my_custom_preprocessor", {})

    def run(self) -> bool:
        """Run preprocessing pipeline."""

        # Iterate over each entry in the mapping
        for entry in self.mapping:

            # The structure for the mapping is explained below:
            # entry["subject"]: The subject name for this entry in mapping.
            # entry["session"]: The session name for this entry in mapping. 
            # entry["type"]: The MRI type name for this entry (type= 'anat' for all brainscape datasets)
            # entry['mris']: A dict with MRI files names, the keys are modality names like (t1w, t2w, flair)
            # entry['download']: A dict with MRI files relative download paths, keys are modality names

            # Your preprocessor plugin has:
            #   - The download dir (self.download_dir) and relative download paths for all modalities (entry['download'])
            #   - The preprocess output (self.preprocess_dir) where your preprocessor plugin should save the preprocessed files
            #   - The plugin configs (self.plugin_config) required for youe preprocessor plugins

            # ------------------------------------------------
            # Your Preprocessor plugin logic goes here. 
            # Should generate preprocessed MRIs.
            # ------------------------------------------------

        return True
```

---

## 4. Integrating your Plugin

To integrate your plugin, edit the dataset-specific `metadata.json` in:

```
BrainScape/<DatasetID>/metadata.json
```

```json
"preprocess": {
  "preprocessor": "my_custom_preprocessor",
  "preprocessDirName": "preprocessed",
  "my_custom_preprocessor": {
    "exampleSetting": "your_plugin_specific_config_value"
  }
}
```

---

## 5. Running and Testing your Plugin

Activate BrainScapeâ€™s environment and run:

```bash
conda activate bs
python src/prepare_dataset.py
```

The PreprocessManager will:

* Load and instantiate your custom preprocessor.
* Execute your custom logic defined in the `run()` method.
* Set `isPreprocessed` in `metadata.json` to `true` upon successful completion.